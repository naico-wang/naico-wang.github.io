import{_ as n,I as l,o,c as d,a6 as a,J as t,w as s}from"./chunks/framework.NCXUupj9.js";const g=JSON.parse('{"title":"MCP 认证与安全","description":"","frontmatter":{"title":"MCP 认证与安全","position":6},"headers":[],"relativePath":"ai/mcp/mcp-security.md","filePath":"ai/mcp/mcp-security.md","lastUpdated":1771245779000}'),h={name:"ai/mcp/mcp-security.md"};function c(p,e,k,b,E,A){const r=l("MermaidChart"),i=l("ClientOnly");return o(),d("div",null,[e[0]||(e[0]=a('<h1 id="mcp-认证与安全最佳实践" tabindex="-1">MCP 认证与安全最佳实践 <a class="header-anchor" href="#mcp-认证与安全最佳实践" aria-label="Permalink to “MCP 认证与安全最佳实践”">​</a></h1><blockquote><p>本文档面向 MCP（Model Context Protocol）系统，提供系统化的安全威胁分析、攻击向量说明与可落地的防护实践指南。</p></blockquote><h2 id="_1-文档目的与适用范围" tabindex="-1">1. 文档目的与适用范围 <a class="header-anchor" href="#_1-文档目的与适用范围" aria-label="Permalink to “1. 文档目的与适用范围”">​</a></h2><h3 id="_1-1-目的" tabindex="-1">1.1 目的 <a class="header-anchor" href="#_1-1-目的" aria-label="Permalink to “1.1 目的”">​</a></h3><p>本文档旨在：</p><ul><li><strong>识别安全风险</strong> — 系统性梳理 MCP 在授权、令牌、会话、本地执行等方面的特有安全威胁</li><li><strong>提供防护指南</strong> — 结合 OAuth 2.1 / OIDC / RFC 规范，给出可执行、可审计的安全最佳实践</li><li><strong>建立统一标准</strong> — 为团队提供一致的安全开发与评审参考</li></ul><h3 id="_1-2-适用角色" tabindex="-1">1.2 适用角色 <a class="header-anchor" href="#_1-2-适用角色" aria-label="Permalink to “1.2 适用角色”">​</a></h3><table tabindex="0"><thead><tr><th>角色</th><th>关注重点</th></tr></thead><tbody><tr><td>MCP Server / Proxy 实现者</td><td>授权流程实现、令牌校验、攻击面防护</td></tr><tr><td>MCP Client / Host Application 开发者</td><td>客户端安全配置、令牌管理、用户同意流程</td></tr><tr><td>安全评估与合规审计人员</td><td>威胁模型、安全检查清单、合规映射</td></tr></tbody></table><h3 id="_1-3-前置知识" tabindex="-1">1.3 前置知识 <a class="header-anchor" href="#_1-3-前置知识" aria-label="Permalink to “1.3 前置知识”">​</a></h3><p>阅读本文档前，建议先了解以下规范：</p><ul><li><a href="https://spec.modelcontextprotocol.io/specification/2025-03-26/basic/authorization/" target="_blank" rel="noreferrer">MCP Authorization Specification</a></li><li><a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13" target="_blank" rel="noreferrer">OAuth 2.1（draft-ietf-oauth-v2-1）</a></li><li><a href="https://datatracker.ietf.org/doc/html/rfc9700" target="_blank" rel="noreferrer">RFC 9700 — OAuth 2.0 Security Best Practices</a></li></ul><h2 id="_2-mcp-授权模型概览" tabindex="-1">2. MCP 授权模型概览 <a class="header-anchor" href="#_2-mcp-授权模型概览" aria-label="Permalink to “2. MCP 授权模型概览”">​</a></h2><p>在 MCP 架构中，授权的核心目标是：</p><ul><li>保护 MCP Server 暴露的 <strong>工具（Tools）</strong> 与 <strong>资源（Resources）</strong></li><li>明确 <code>谁</code> 在 <code>什么上下文</code> 下执行了 <code>哪些操作</code></li></ul><h3 id="_2-1-设计原则" tabindex="-1">2.1 设计原则 <a class="header-anchor" href="#_2-1-设计原则" aria-label="Permalink to “2.1 设计原则”">​</a></h3><p>MCP 的授权模型遵循以下原则：</p><table tabindex="0"><thead><tr><th>原则</th><th>说明</th></tr></thead><tbody><tr><td>不绑定特定身份系统</td><td>OIDC、企业 IdP、SaaS OAuth 均可作为上游身份源</td></tr><tr><td>严格遵循 OAuth 2.1</td><td>强制 PKCE，禁止隐式流（Implicit Flow）</td></tr><tr><td>标准发现机制</td><td>通过 RFC 9728（Protected Resource Metadata）和 <br>RFC 8414（Authorization Server Metadata）建立信任</td></tr></tbody></table><p><strong>关键认知</strong>：MCP 本身不是自定义认证协议，而是 OAuth 体系中的 <strong>受保护资源（Protected Resource）</strong>。MCP Server 的角色等同于 OAuth 资源服务器。</p><h3 id="_2-2-何时必须启用授权" tabindex="-1">2.2 何时必须启用授权 <a class="header-anchor" href="#_2-2-何时必须启用授权" aria-label="Permalink to “2.2 何时必须启用授权”">​</a></h3><p>MCP Server 可以匿名运行，但在以下任一场景中，<strong>授权是强制要求</strong>：</p><ul><li>访问用户私有数据或租户隔离数据（文档、邮件、数据库）</li><li>涉及管理类或破坏性操作（删除、修改配置等）</li><li>需要审计、计费、速率限制或配额控制</li><li>代理第三方 API（OAuth Delegation 场景）</li><li>企业或合规环境（SOC 2、ISO 27001、GDPR）</li></ul><h3 id="_2-3-本地-mcp-server-的特殊说明" tabindex="-1">2.3 本地 MCP Server 的特殊说明 <a class="header-anchor" href="#_2-3-本地-mcp-server-的特殊说明" aria-label="Permalink to “2.3 本地 MCP Server 的特殊说明”">​</a></h3><p>使用 <code>stdio</code> 传输的本地 MCP Server 不走 HTTP，因此 OAuth 流程不直接适用。此类场景的凭证管理方式包括：</p><ul><li><strong>环境变量</strong> — 通过 <code>MCP_API_KEY</code> 等环境变量传递凭证</li><li><strong>系统凭证存储</strong> — 使用 macOS Keychain、Windows Credential Manager 或 Linux Secret Service</li><li><strong>配置文件</strong> — 加密存储于本地配置文件中（需控制文件权限为 <code>600</code>）</li></ul><blockquote><p>OAuth 授权流程主要适用于 <strong>远程、HTTP 传输的 MCP Server</strong>。</p></blockquote><h2 id="_3-mcp-标准授权流程-oauth-2-1" tabindex="-1">3. MCP 标准授权流程（OAuth 2.1） <a class="header-anchor" href="#_3-mcp-标准授权流程-oauth-2-1" aria-label="Permalink to “3. MCP 标准授权流程（OAuth 2.1）”">​</a></h2><p>本节以端到端视角说明 MCP Client 首次访问受保护 MCP Server 的完整流程。</p>',27)),t(i,null,{default:s(()=>[t(r,{code:"sequenceDiagram%0A%20%20%20%20participant%20Client%20as%20MCP%20Client%3Cbr%2F%3E(Host%20App)%0A%20%20%20%20participant%20Server%20as%20MCP%20Server%3Cbr%2F%3E(Resource)%0A%20%20%20%20participant%20AuthZ%20as%20Authorization%3Cbr%2F%3EServer%0A%20%20%20%20participant%20IdP%20as%20Identity%3Cbr%2F%3EProvider%0A%0A%20%20%20%20Client-%3E%3EServer%3A%201.%20%E8%AF%B7%E6%B1%82%E8%B5%84%E6%BA%90%0A%20%20%20%20Server--%3E%3EClient%3A%202.%20401%20Unauthorized%20%2B%20PRM%20URL%0A%20%20%20%20Client-%3E%3EServer%3A%203.%20%E8%8E%B7%E5%8F%96%20Protected%20Resource%20Metadata%0A%20%20%20%20Client-%3E%3EAuthZ%3A%204.%20%E5%8F%91%E7%8E%B0%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88RFC%208414%EF%BC%89%0A%20%20%20%20Client-%3E%3EAuthZ%3A%205.%20%E6%8E%88%E6%9D%83%E8%AF%B7%E6%B1%82%EF%BC%88Authorization%20Code%20%2B%20PKCE%EF%BC%89%0A%20%20%20%20AuthZ-%3E%3EIdP%3A%20%E8%BD%AC%E5%8F%91%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%0A%20%20%20%20IdP--%3E%3EClient%3A%206.%20%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E4%B8%8E%E5%90%8C%E6%84%8F%0A%20%20%20%20Client-%3E%3EAuthZ%3A%207.%20%E4%BB%A4%E7%89%8C%E4%BA%A4%E6%8D%A2%EF%BC%88Code%20%E2%86%92%20Token%EF%BC%89%0A%20%20%20%20AuthZ--%3E%3EClient%3A%20%E8%BF%94%E5%9B%9E%20Access%20Token%0A%20%20%20%20Client-%3E%3EServer%3A%208.%20%E6%90%BA%E5%B8%A6%20Bearer%20Token%20%E8%AE%BF%E9%97%AE%0A%20%20%20%20Server--%3E%3EClient%3A%20%E8%BF%94%E5%9B%9E%E5%8F%97%E4%BF%9D%E6%8A%A4%E8%B5%84%E6%BA%90%0A",showToolbar:"1"})]),_:1}),e[1]||(e[1]=a(`<h3 id="_3-1-初始握手-401-challenge" tabindex="-1">3.1 初始握手（401 Challenge） <a class="header-anchor" href="#_3-1-初始握手-401-challenge" aria-label="Permalink to “3.1 初始握手（401 Challenge）”">​</a></h3><p>当 MCP Client 首次发起未认证请求时，MCP Server 返回 <code>401 Unauthorized</code>，并通过 <code>WWW-Authenticate</code> 头指向 Protected Resource Metadata（PRM）：</p><div class="language-http line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">HTTP</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">/</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;">1.1</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;"> 401</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> Unauthorized</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">WWW-Authenticate</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> Bearer realm=&quot;mcp&quot;,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  resource_metadata=&quot;https://mcp.example.com/.well-known/oauth-protected-resource&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>安全要求</strong>：</p><ul><li><strong>禁止泄露实现细节</strong> — 401 响应中不得包含服务器版本、框架信息等</li><li><strong>强制 HTTPS</strong> — PRM URL 必须为 HTTPS 协议</li><li><strong>限制响应头</strong> — 不在错误响应中暴露内部路径或调试信息</li></ul><h3 id="_3-2-受保护资源元数据-rfc-9728" tabindex="-1">3.2 受保护资源元数据（RFC 9728） <a class="header-anchor" href="#_3-2-受保护资源元数据-rfc-9728" aria-label="Permalink to “3.2 受保护资源元数据（RFC 9728）”">​</a></h3><p>PRM 文档描述了 MCP Server 的授权边界，客户端通过该文档了解如何获取访问权限：</p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">{</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;resource&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;https://mcp.example.com/mcp&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;authorization_servers&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;https://auth.example.com&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">]</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;scopes_supported&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;mcp:tools:read&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;mcp:tools:execute&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;mcp:resources:read&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">]</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;bearer_methods_supported&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;header&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">]</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>最佳实践</strong>：</p><ul><li><code>scopes_supported</code> 仅暴露最小且稳定的作用域集合</li><li>避免使用通配符作用域（如 <code>*</code> 或 <code>all</code>）</li><li>作用域命名采用 <code>namespace:resource:action</code> 格式，语义清晰</li></ul><h3 id="_3-3-授权服务器发现-rfc-8414" tabindex="-1">3.3 授权服务器发现（RFC 8414） <a class="header-anchor" href="#_3-3-授权服务器发现-rfc-8414" aria-label="Permalink to “3.3 授权服务器发现（RFC 8414）”">​</a></h3><p>客户端根据 PRM 中的 <code>authorization_servers</code> 地址，通过标准 Discovery Endpoint 获取授权服务器配置：</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span>GET https://auth.example.com/.well-known/oauth-authorization-server</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>返回的关键端点包括：</p><table tabindex="0"><thead><tr><th>端点</th><th>用途</th></tr></thead><tbody><tr><td><code>authorization_endpoint</code></td><td>用户授权入口</td></tr><tr><td><code>token_endpoint</code></td><td>令牌交换</td></tr><tr><td><code>registration_endpoint</code></td><td>动态客户端注册（可选）</td></tr></tbody></table><blockquote><p><strong>安全提示</strong>：此阶段是 SSRF 攻击的高危入口，防护措施见 <a href="#_53-ssrf服务端请求伪造">5.3 节</a>。</p></blockquote><h3 id="_3-4-客户端注册" tabindex="-1">3.4 客户端注册 <a class="header-anchor" href="#_3-4-客户端注册" aria-label="Permalink to “3.4 客户端注册”">​</a></h3><p>MCP 支持两种客户端注册模式：</p><p><strong>预注册（推荐用于企业/内部系统）</strong></p><ul><li>客户端信息预先录入授权服务器</li><li><code>client_id</code> 和 <code>client_secret</code> 通过安全通道分发</li><li>适用于可控环境，安全性更高</li></ul><p><strong>动态客户端注册（DCR）</strong></p><ul><li>遵循 RFC 7591，客户端运行时自注册</li><li>适用于开放生态或不可预知客户端的场景</li></ul><p><strong>DCR 安全要求</strong>：</p><ul><li>严格校验 <code>redirect_uris</code>，仅允许 HTTPS 且精确匹配（禁止通配符）</li><li>记录并审计 <code>client_id</code> ↔ <code>owner</code> ↔ <code>scopes</code> 的映射关系</li><li>设置注册频率限制，防止滥用</li><li>可选要求 <code>software_statement</code>（签名的客户端声明）</li></ul><h3 id="_3-5-用户授权-authorization-code-pkce" tabindex="-1">3.5 用户授权（Authorization Code + PKCE） <a class="header-anchor" href="#_3-5-用户授权-authorization-code-pkce" aria-label="Permalink to “3.5 用户授权（Authorization Code + PKCE）”">​</a></h3><p>MCP 强制使用 Authorization Code Flow + PKCE，具体要求：</p><table tabindex="0"><thead><tr><th>要求</th><th>说明</th></tr></thead><tbody><tr><td>强制 PKCE</td><td>使用 <code>S256</code> 方法，禁止 <code>plain</code></td></tr><tr><td>禁止隐式流</td><td>不允许 <code>response_type=token</code></td></tr><tr><td>明确同意内容</td><td>授权页面须展示请求的 scope 和 redirect_uri</td></tr><tr><td>state 参数</td><td>必须使用 CSPRNG 生成，防止 CSRF</td></tr></tbody></table><h3 id="_3-6-携带令牌访问-mcp-server" tabindex="-1">3.6 携带令牌访问 MCP Server <a class="header-anchor" href="#_3-6-携带令牌访问-mcp-server" aria-label="Permalink to “3.6 携带令牌访问 MCP Server”">​</a></h3><p>获取令牌后，客户端通过 <code>Authorization</code> 头携带令牌访问 MCP Server：</p><div class="language-http line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">http</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">GET</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> /mcp/tools/list </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">HTTP</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">/</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;">1.1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">Host</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> mcp.example.com</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">Authorization</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> Bearer &lt;access_token&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>MCP Server 必须执行以下校验</strong>：</p><ol><li><strong>签名校验</strong> — 验证令牌签名的完整性（JWT 场景下验证 JWS 签名）</li><li><strong>签发者校验</strong> — 验证 <code>iss</code> claim 与预期授权服务器一致</li><li><strong>受众校验</strong> — 验证 <code>aud</code> claim 包含当前 MCP Server 的标识</li><li><strong>有效期校验</strong> — 验证 <code>exp</code> 未过期，<code>nbf</code> 已生效</li><li><strong>权限校验</strong> — 将令牌中的 <code>scope</code> 映射到实际的工具/资源访问权限</li></ol><h2 id="_4-令牌管理" tabindex="-1">4. 令牌管理 <a class="header-anchor" href="#_4-令牌管理" aria-label="Permalink to “4. 令牌管理”">​</a></h2><h3 id="_4-1-令牌类型与用途" tabindex="-1">4.1 令牌类型与用途 <a class="header-anchor" href="#_4-1-令牌类型与用途" aria-label="Permalink to “4.1 令牌类型与用途”">​</a></h3><table tabindex="0"><thead><tr><th>令牌类型</th><th>用途</th><th>生命周期</th><th>存储要求</th></tr></thead><tbody><tr><td>Access Token</td><td>访问 MCP Server 资源</td><td>短期（15–60 分钟）</td><td>内存存储，不持久化</td></tr><tr><td>Refresh Token</td><td>续签 Access Token</td><td>中期（数小时至数天）</td><td>加密存储，绑定客户端</td></tr><tr><td>Authorization Code</td><td>一次性令牌交换</td><td>极短（10 分钟内）</td><td>使用后立即作废</td></tr></tbody></table><h3 id="_4-2-令牌生命周期管理" tabindex="-1">4.2 令牌生命周期管理 <a class="header-anchor" href="#_4-2-令牌生命周期管理" aria-label="Permalink to “4.2 令牌生命周期管理”">​</a></h3><p><strong>签发阶段</strong>：</p><ul><li>Access Token 有效期不超过 60 分钟</li><li>Refresh Token 实施轮转（Rotation），每次使用后签发新 Refresh Token 并作废旧令牌</li><li>所有令牌必须绑定 <code>client_id</code>，Refresh Token 还应绑定 <code>user_id</code></li></ul><p><strong>使用阶段</strong>：</p><ul><li>客户端在 Access Token 过期前主动刷新，避免中断</li><li>遇到 <code>401</code> 响应时，先尝试刷新令牌，而非重新触发授权流程</li><li>禁止在 URL 查询参数中传递令牌</li></ul><p><strong>撤销阶段</strong>：</p><ul><li>支持主动撤销（RFC 7009 Token Revocation）</li><li>用户取消授权时，同时撤销关联的所有 Access Token 和 Refresh Token</li><li>检测到安全异常时，支持批量撤销指定客户端的所有令牌</li></ul><h2 id="_5-关键攻击向量与防护" tabindex="-1">5. 关键攻击向量与防护 <a class="header-anchor" href="#_5-关键攻击向量与防护" aria-label="Permalink to “5. 关键攻击向量与防护”">​</a></h2><p>本节系统性地分析 MCP 场景下的主要安全威胁，每个攻击向量包含风险描述、影响范围和防护措施。</p><h3 id="_5-1-混淆代理攻击-confused-deputy" tabindex="-1">5.1 混淆代理攻击（Confused Deputy） <a class="header-anchor" href="#_5-1-混淆代理攻击-confused-deputy" aria-label="Permalink to “5.1 混淆代理攻击（Confused Deputy）”">​</a></h3><h4 id="风险描述" tabindex="-1">风险描述 <a class="header-anchor" href="#风险描述" aria-label="Permalink to “风险描述”">​</a></h4><p>MCP Proxy 同时充当多个角色：</p><ul><li>面向多个 MCP Client 的 OAuth Client</li><li>面向第三方 API 的单一 OAuth Client</li></ul><p>如果<strong>同意边界未隔离</strong>，攻击者可利用一个客户端的授权执行另一个客户端的操作，导致越权访问。</p><h4 id="攻击示例" tabindex="-1">攻击示例 <a class="header-anchor" href="#攻击示例" aria-label="Permalink to “攻击示例”">​</a></h4>`,50)),t(i,null,{default:s(()=>[t(r,{code:"sequenceDiagram%0A%20%20%20%20participant%20A%20as%20%E6%94%BB%E5%87%BB%E8%80%85%20Client%20A%0A%20%20%20%20participant%20Proxy%20as%20MCP%20Proxy%0A%20%20%20%20participant%20API%20as%20%E7%AC%AC%E4%B8%89%E6%96%B9%20API%0A%20%20%20%20participant%20B%20as%20%E6%AD%A3%E5%B8%B8%20Client%20B%0A%0A%20%20%20%20A-%3E%3EProxy%3A%20%E8%AF%B7%E6%B1%82%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E7%AC%AC%E4%B8%89%E6%96%B9%20API%0A%20%20%20%20Proxy-%3E%3EAPI%3A%20%E8%8E%B7%E5%8F%96%20OAuth%20%E6%8E%88%E6%9D%83%0A%20%20%20%20API--%3E%3EProxy%3A%20%E8%BF%94%E5%9B%9E%E6%8E%88%E6%9D%83%E5%87%AD%E6%8D%AE%0A%20%20%20%20Note%20over%20Proxy%3A%20Proxy%20%E7%BC%93%E5%AD%98%E4%BA%86%E6%8E%88%E6%9D%83%E5%87%AD%E6%8D%AE%3Cbr%2F%3E%E6%9C%AA%E9%9A%94%E7%A6%BB%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BE%B9%E7%95%8C%0A%0A%20%20%20%20B-%3E%3EProxy%3A%20%E8%AF%B7%E6%B1%82%E7%9B%B8%E5%90%8C%E7%AC%AC%E4%B8%89%E6%96%B9%20API%0A%20%20%20%20Proxy-%3E%3EAPI%3A%20%E9%94%99%E8%AF%AF%E5%A4%8D%E7%94%A8%20Client%20A%20%E7%9A%84%E6%8E%88%E6%9D%83%E5%87%AD%E6%8D%AE%0A%20%20%20%20API--%3E%3EProxy%3A%20%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%0A%20%20%20%20Proxy--%3E%3EB%3A%20%E8%B6%8A%E6%9D%83%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%0A",showToolbar:"1"})]),_:1}),e[2]||(e[2]=a('<h4 id="防护措施" tabindex="-1">防护措施 <a class="header-anchor" href="#防护措施" aria-label="Permalink to “防护措施”">​</a></h4><table tabindex="0"><thead><tr><th>措施</th><th>说明</th></tr></thead><tbody><tr><td>逐客户端独立同意</td><td>每个 <code>client_id</code> 必须独立完成授权同意流程</td></tr><tr><td>同意前置校验</td><td>同意必须在转发到第三方 API <strong>之前</strong>完成</td></tr><tr><td>redirect_uri 精确匹配</td><td>禁止模糊匹配或通配符</td></tr><tr><td>state 参数绑定</td><td><code>state</code> 仅在用户完成同意后生成，并绑定到具体的 <code>client_id</code></td></tr></tbody></table><p><strong>核心原则</strong>：第三方 API 的授权凭据不等于 MCP Client 的授权，两者必须严格隔离。</p><h3 id="_5-2-令牌传递攻击-token-forwarding" tabindex="-1">5.2 令牌传递攻击（Token Forwarding） <a class="header-anchor" href="#_5-2-令牌传递攻击-token-forwarding" aria-label="Permalink to “5.2 令牌传递攻击（Token Forwarding）”">​</a></h3><h4 id="风险描述-1" tabindex="-1">风险描述 <a class="header-anchor" href="#风险描述-1" aria-label="Permalink to “风险描述”">​</a></h4><p>MCP Server 接受并使用「不是为自己签发」的令牌来访问下游服务，导致令牌被跨边界滥用。</p><h4 id="明确禁止" tabindex="-1">明确禁止 <a class="header-anchor" href="#明确禁止" aria-label="Permalink to “明确禁止”">​</a></h4><ul><li>禁止将客户端传入的 Access Token 原样转发给下游 API</li><li>禁止 MCP Server 接受 <code>aud</code> 不包含自身标识的令牌</li></ul><h4 id="正确的下游调用模式" tabindex="-1">正确的下游调用模式 <a class="header-anchor" href="#正确的下游调用模式" aria-label="Permalink to “正确的下游调用模式”">​</a></h4><p>当 MCP Server 需要代表用户调用下游服务时，应使用以下标准机制：</p><table tabindex="0"><thead><tr><th>机制</th><th>适用场景</th><th>规范</th></tr></thead><tbody><tr><td>Token Exchange</td><td>将用户令牌交换为下游服务专用令牌</td><td>RFC 8693</td></tr><tr><td>On-Behalf-Of（OBO）</td><td>以用户身份调用下游服务</td><td>Azure AD OBO / 类似机制</td></tr><tr><td>Client Credentials</td><td>MCP Server 以自身身份调用下游服务</td><td>OAuth 2.1</td></tr></tbody></table><h3 id="_5-3-ssrf-服务端请求伪造" tabindex="-1">5.3 SSRF（服务端请求伪造） <a class="header-anchor" href="#_5-3-ssrf-服务端请求伪造" aria-label="Permalink to “5.3 SSRF（服务端请求伪造）”">​</a></h3><h4 id="风险描述-2" tabindex="-1">风险描述 <a class="header-anchor" href="#风险描述-2" aria-label="Permalink to “风险描述”">​</a></h4><p>在 OAuth 元数据发现阶段，MCP Client 或 Proxy 需要获取多个远程 URL。攻击者可通过篡改元数据中的 URL，诱导服务端向内部网络发起请求。</p><h4 id="高危入口" tabindex="-1">高危入口 <a class="header-anchor" href="#高危入口" aria-label="Permalink to “高危入口”">​</a></h4><p>以下字段中的 URL 均为 SSRF 攻击面：</p><ul><li><code>resource_metadata</code>（PRM 文档地址）</li><li><code>authorization_servers</code>（授权服务器地址）</li><li><code>token_endpoint</code> / <code>authorization_endpoint</code>（具体端点）</li></ul><h4 id="防护措施-1" tabindex="-1">防护措施 <a class="header-anchor" href="#防护措施-1" aria-label="Permalink to “防护措施”">​</a></h4>',18)),t(i,null,{default:s(()=>[t(r,{code:"flowchart%20LR%0A%20%20%20%20A%5B%E8%AF%B7%E6%B1%82%20URL%5D%20--%3E%20B%5B%E5%8D%8F%E8%AE%AE%E6%A0%A1%E9%AA%8C%3Cbr%2F%3E%E4%BB%85%E5%85%81%E8%AE%B8%20HTTPS%5D%0A%20%20%20%20B%20--%3E%20C%5BDNS%20%E8%A7%A3%E6%9E%90%3Cbr%2F%3E%E9%98%BB%E6%96%AD%E7%A7%81%E6%9C%89%20IP%3Cbr%2F%3E169.254.x.x%3Cbr%2F%3E10.x.x.x%3Cbr%2F%3E172.16-31.x.x%3Cbr%2F%3E192.168.x.x%5D%0A%20%20%20%20C%20--%3E%20D%5BIP%20%E6%A0%A1%E9%AA%8C%3Cbr%2F%3E%E9%98%BB%E6%96%AD%E5%9B%9E%E7%8E%AF%E5%9C%B0%E5%9D%80%3Cbr%2F%3E127.0.0.0%2F8%3Cbr%2F%3E%3A%3A1%5D%0A%20%20%20%20D%20--%3E%20E%5B%E5%87%BA%E5%8F%A3%E4%BB%A3%E7%90%86%3Cbr%2F%3ESmokescreen%3Cbr%2F%3E%E7%AD%89%E4%BB%A3%E7%90%86%E5%B7%A5%E5%85%B7%5D%0A%20%20%20%20E%20--%3E%20F%5B%E7%9B%AE%E6%A0%87%E6%9C%8D%E5%8A%A1%E5%99%A8%5D%0A%0A%20%20%20%20style%20B%20fill%3A%23f9f%2Cstroke%3A%23333%0A%20%20%20%20style%20C%20fill%3A%23ff9%2Cstroke%3A%23333%0A%20%20%20%20style%20D%20fill%3A%23ff9%2Cstroke%3A%23333%0A%20%20%20%20style%20E%20fill%3A%239cf%2Cstroke%3A%23333%0A",showToolbar:"1"})]),_:1}),e[3]||(e[3]=a(`<p><strong>必须执行的防护</strong>：</p><ol><li><strong>强制 HTTPS</strong> — 所有元数据 URL 必须为 HTTPS 协议</li><li><strong>阻断私有 IP</strong> — DNS 解析后校验目标 IP，阻断 RFC 1918 私有地址和链路本地地址（169.254.0.0/16）</li><li><strong>校验重定向链</strong> — 对 HTTP 重定向的每一跳都执行 IP 校验</li><li><strong>使用出口代理</strong> — 通过 Smokescreen 等出口代理统一管控外部请求</li><li><strong>设置超时</strong> — 对元数据获取请求设置严格的超时限制（建议 5 秒）</li></ol><h3 id="_5-4-会话劫持与事件注入" tabindex="-1">5.4 会话劫持与事件注入 <a class="header-anchor" href="#_5-4-会话劫持与事件注入" aria-label="Permalink to “5.4 会话劫持与事件注入”">​</a></h3><h4 id="风险描述-3" tabindex="-1">风险描述 <a class="header-anchor" href="#风险描述-3" aria-label="Permalink to “风险描述”">​</a></h4><p>MCP 基于长连接（SSE / WebSocket）通信，如果会话管理不当，攻击者可能劫持会话或注入恶意事件。</p><h4 id="核心原则" tabindex="-1">核心原则 <a class="header-anchor" href="#核心原则" aria-label="Permalink to “核心原则”">​</a></h4><p><strong>会话不等于身份</strong>。会话标识符仅用于关联连接状态，不能作为唯一的鉴权依据。每个请求都必须独立验证授权。</p><h4 id="防护措施-2" tabindex="-1">防护措施 <a class="header-anchor" href="#防护措施-2" aria-label="Permalink to “防护措施”">​</a></h4><table tabindex="0"><thead><tr><th>措施</th><th>说明</th></tr></thead><tbody><tr><td>session_id 生成</td><td>使用 CSPRNG（密码学安全随机数生成器），长度不低于 128 位</td></tr><tr><td>绑定用户身份</td><td><code>session_id</code> 与 <code>user_id</code>、<code>client_id</code> 绑定，防止会话漂移</td></tr><tr><td>独立鉴权</td><td>不使用 session 作为唯一鉴权手段，每个请求仍需校验 Bearer Token</td></tr><tr><td>事件来源校验</td><td>SSE / WebSocket 消息需校验来源，防止注入伪造事件</td></tr><tr><td>会话超时</td><td>设置空闲超时（建议 30 分钟）和绝对超时（建议 24 小时）</td></tr></tbody></table><h3 id="_5-5-本地-mcp-server-安全" tabindex="-1">5.5 本地 MCP Server 安全 <a class="header-anchor" href="#_5-5-本地-mcp-server-安全" aria-label="Permalink to “5.5 本地 MCP Server 安全”">​</a></h3><h4 id="风险描述-4" tabindex="-1">风险描述 <a class="header-anchor" href="#风险描述-4" aria-label="Permalink to “风险描述”">​</a></h4><p>本地 MCP Server 以用户权限在本机运行，具有直接访问文件系统、执行命令和网络通信的能力，风险等级高于远程服务。</p><h4 id="核心威胁" tabindex="-1">核心威胁 <a class="header-anchor" href="#核心威胁" aria-label="Permalink to “核心威胁”">​</a></h4><table tabindex="0"><thead><tr><th>威胁</th><th>说明</th></tr></thead><tbody><tr><td>任意代码执行</td><td>恶意 MCP Server 可在用户权限下执行任意命令</td></tr><tr><td>权限继承</td><td>MCP Server 继承宿主进程的全部权限（文件、网络、环境变量）</td></tr><tr><td>数据外泄</td><td>读取本地敏感文件后通过网络外传（如 SSH 密钥、凭证文件）</td></tr><tr><td>供应链攻击</td><td>通过 npm/pip 等包管理器安装的恶意 MCP Server 包</td></tr></tbody></table><h4 id="客户端-host-application-安全要求" tabindex="-1">客户端（Host Application）安全要求 <a class="header-anchor" href="#客户端-host-application-安全要求" aria-label="Permalink to “客户端（Host Application）安全要求”">​</a></h4><ol><li><strong>命令预览</strong> — 执行前向用户完整展示将要执行的命令或操作</li><li><strong>风险提示</strong> — 对文件写入、命令执行、网络请求等敏感操作给出明确风险提示</li><li><strong>用户显式确认</strong> — 敏感操作必须经过用户明确的确认（不可静默执行）</li><li><strong>来源审计</strong> — 记录 MCP Server 的来源、版本和哈希值</li></ol><h4 id="服务端安全建议" tabindex="-1">服务端安全建议 <a class="header-anchor" href="#服务端安全建议" aria-label="Permalink to “服务端安全建议”">​</a></h4><ol><li><strong>优先使用 stdio 传输</strong> — 避免暴露网络端口</li><li><strong>最小权限运行</strong> — 使用专用低权限用户运行，避免 root / admin</li><li><strong>沙箱隔离</strong> — 使用 Docker 容器、macOS Sandbox 或 Linux namespace 限制文件系统和网络访问</li><li><strong>限制出站网络</strong> — 如非必要，禁止 MCP Server 发起外部网络请求</li></ol><h3 id="_5-6-作用域设计-scope-design" tabindex="-1">5.6 作用域设计（Scope Design） <a class="header-anchor" href="#_5-6-作用域设计-scope-design" aria-label="Permalink to “5.6 作用域设计（Scope Design）”">​</a></h3><h4 id="设计原则" tabindex="-1">设计原则 <a class="header-anchor" href="#设计原则" aria-label="Permalink to “设计原则”">​</a></h4><table tabindex="0"><thead><tr><th>原则</th><th>说明</th></tr></thead><tbody><tr><td>最小初始权限</td><td>初始授权仅包含完成当前操作所需的最小 scope</td></tr><tr><td>按需提升</td><td>需要额外权限时，通过增量授权（Incremental Authorization）请求</td></tr><tr><td>语义明确</td><td>每个 scope 对应明确的资源和操作，用户可理解其含义</td></tr></tbody></table><h4 id="推荐的-scope-命名规范" tabindex="-1">推荐的 Scope 命名规范 <a class="header-anchor" href="#推荐的-scope-命名规范" aria-label="Permalink to “推荐的 Scope 命名规范”">​</a></h4><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span>mcp:tools:read        # 列出可用工具</span></span>
<span class="line"><span>mcp:tools:execute     # 执行工具调用</span></span>
<span class="line"><span>mcp:resources:read    # 读取资源</span></span>
<span class="line"><span>mcp:resources:write   # 写入资源</span></span>
<span class="line"><span>mcp:prompts:read      # 读取提示模板</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="反模式-必须避免" tabindex="-1">反模式（必须避免） <a class="header-anchor" href="#反模式-必须避免" aria-label="Permalink to “反模式（必须避免）”">​</a></h4><table tabindex="0"><thead><tr><th>反模式</th><th>风险</th></tr></thead><tbody><tr><td>使用 <code>*</code> 或 <code>all</code> 作为 scope</td><td>授予无限权限，违反最小权限原则</td></tr><tr><td>预授权未来能力</td><td>当前未使用的 scope 不应预先授予</td></tr><tr><td>scope 不做服务端校验</td><td>scope 仅声明意图，MCP Server 必须独立校验实际权限</td></tr></tbody></table><h2 id="_6-安全检查清单" tabindex="-1">6. 安全检查清单 <a class="header-anchor" href="#_6-安全检查清单" aria-label="Permalink to “6. 安全检查清单”">​</a></h2><p>以下检查清单可用于开发自检和安全评审。</p><h3 id="_6-1-授权与认证" tabindex="-1">6.1 授权与认证 <a class="header-anchor" href="#_6-1-授权与认证" aria-label="Permalink to “6.1 授权与认证”">​</a></h3><ul><li>[ ] 所有远程 MCP Server 均启用 OAuth 2.1 授权</li><li>[ ] 强制使用 PKCE（<code>S256</code> 方法）</li><li>[ ] 禁用隐式流（Implicit Flow）</li><li>[ ] <code>redirect_uri</code> 精确匹配，无通配符</li><li>[ ] <code>state</code> 参数使用 CSPRNG 生成</li></ul><h3 id="_6-2-令牌安全" tabindex="-1">6.2 令牌安全 <a class="header-anchor" href="#_6-2-令牌安全" aria-label="Permalink to “6.2 令牌安全”">​</a></h3><ul><li>[ ] Access Token 有效期不超过 60 分钟</li><li>[ ] Refresh Token 实施轮转（Rotation）</li><li>[ ] MCP Server 校验令牌的 <code>iss</code>、<code>aud</code>、<code>exp</code>、<code>scope</code></li><li>[ ] 禁止原样转发令牌到下游服务</li><li>[ ] 支持令牌主动撤销（RFC 7009）</li></ul><h3 id="_6-3-网络安全" tabindex="-1">6.3 网络安全 <a class="header-anchor" href="#_6-3-网络安全" aria-label="Permalink to “6.3 网络安全”">​</a></h3><ul><li>[ ] 所有元数据 URL 强制 HTTPS</li><li>[ ] 实施 SSRF 防护（私有 IP 阻断、重定向链校验）</li><li>[ ] 元数据请求设置超时限制</li><li>[ ] 通过出口代理管控外部请求（可选但推荐）</li></ul><h3 id="_6-4-会话安全" tabindex="-1">6.4 会话安全 <a class="header-anchor" href="#_6-4-会话安全" aria-label="Permalink to “6.4 会话安全”">​</a></h3><ul><li>[ ] session_id 使用 CSPRNG 生成（≥ 128 位）</li><li>[ ] session_id 绑定用户身份</li><li>[ ] 每个请求独立校验 Bearer Token</li><li>[ ] 配置会话空闲超时和绝对超时</li></ul><h3 id="_6-5-本地执行安全" tabindex="-1">6.5 本地执行安全 <a class="header-anchor" href="#_6-5-本地执行安全" aria-label="Permalink to “6.5 本地执行安全”">​</a></h3><ul><li>[ ] 敏感操作前展示完整命令并要求用户确认</li><li>[ ] MCP Server 以最小权限运行</li><li>[ ] 使用沙箱或容器隔离本地 MCP Server</li><li>[ ] 记录 MCP Server 来源、版本和完整性哈希</li></ul><h3 id="_6-6-scope-与权限" tabindex="-1">6.6 Scope 与权限 <a class="header-anchor" href="#_6-6-scope-与权限" aria-label="Permalink to “6.6 Scope 与权限”">​</a></h3><ul><li>[ ] 使用细粒度 scope，禁止 <code>*</code> / <code>all</code></li><li>[ ] 初始授权仅包含最小必要 scope</li><li>[ ] MCP Server 独立校验 scope 对应的实际权限</li><li>[ ] 用户可查看并撤销已授予的权限</li></ul><h2 id="_7-总结" tabindex="-1">7. 总结 <a class="header-anchor" href="#_7-总结" aria-label="Permalink to “7. 总结”">​</a></h2><p>MCP 安全的核心原则：</p><ol><li><strong>OAuth 不等于自动安全</strong> — OAuth 提供框架，安全取决于正确的实现</li><li><strong>MCP Proxy 不是信任边界</strong> — Proxy 不改变授权语义，每一跳都需独立鉴权</li><li><strong>令牌必须有明确受众</strong> — 每个令牌只应被其目标受众接受和使用</li><li><strong>同意必须可解释、可审计、可撤销</strong> — 用户应能理解授予了什么权限，系统应能追溯和回收</li><li><strong>本地执行永远假设不安全</strong> — 本地 MCP Server 具有最高风险等级，必须施加最严格的约束</li></ol><h2 id="_8-参考资料" tabindex="-1">8. 参考资料 <a class="header-anchor" href="#_8-参考资料" aria-label="Permalink to “8. 参考资料”">​</a></h2><table tabindex="0"><thead><tr><th>资料</th><th>链接</th></tr></thead><tbody><tr><td>MCP Authorization Specification</td><td><a href="https://spec.modelcontextprotocol.io/specification/2025-03-26/basic/authorization/" target="_blank" rel="noreferrer">spec.modelcontextprotocol.io</a></td></tr><tr><td>OAuth 2.1</td><td><a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-13" target="_blank" rel="noreferrer">draft-ietf-oauth-v2-1-13</a></td></tr><tr><td>RFC 9700 — OAuth 2.0 Security Best Practices</td><td><a href="https://datatracker.ietf.org/doc/html/rfc9700" target="_blank" rel="noreferrer">datatracker.ietf.org</a></td></tr><tr><td>RFC 9728 — Protected Resource Metadata</td><td><a href="https://datatracker.ietf.org/doc/html/rfc9728" target="_blank" rel="noreferrer">datatracker.ietf.org</a></td></tr><tr><td>RFC 8414 — Authorization Server Metadata</td><td><a href="https://datatracker.ietf.org/doc/html/rfc8414" target="_blank" rel="noreferrer">datatracker.ietf.org</a></td></tr><tr><td>RFC 8693 — Token Exchange</td><td><a href="https://datatracker.ietf.org/doc/html/rfc8693" target="_blank" rel="noreferrer">datatracker.ietf.org</a></td></tr><tr><td>RFC 7009 — Token Revocation</td><td><a href="https://datatracker.ietf.org/doc/html/rfc7009" target="_blank" rel="noreferrer">datatracker.ietf.org</a></td></tr><tr><td>OWASP SSRF Prevention Cheat Sheet</td><td><a href="https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html" target="_blank" rel="noreferrer">cheatsheetseries.owasp.org</a></td></tr><tr><td>OWASP Top 10 A10:2021 — SSRF</td><td><a href="https://owasp.org/Top10/2021/A10_2021-Server-Side_Request_Forgery_%28SSRF%29/" target="_blank" rel="noreferrer">owasp.org</a></td></tr></tbody></table>`,44))])}const C=n(h,[["render",c]]);export{g as __pageData,C as default};
