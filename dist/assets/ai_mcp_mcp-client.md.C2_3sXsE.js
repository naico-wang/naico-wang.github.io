import{_ as t,I as h,o as k,c as e,a6 as a,J as i,w as p}from"./chunks/framework.NCXUupj9.js";const b=JSON.parse('{"title":"MCP 客户端开发指南","description":"","frontmatter":{"title":"MCP 客户端开发指南","position":3,"outline":[2,2]},"headers":[],"relativePath":"ai/mcp/mcp-client.md","filePath":"ai/mcp/mcp-client.md","lastUpdated":1771245779000}'),r={name:"ai/mcp/mcp-client.md"};function F(d,s,B,g,y,c){const n=h("MermaidChart"),l=h("ClientOnly");return k(),e("div",null,[s[0]||(s[0]=a('<h1 id="mcp-客户端开发指南" tabindex="-1">MCP 客户端开发指南 <a class="header-anchor" href="#mcp-客户端开发指南" aria-label="Permalink to “MCP 客户端开发指南”">​</a></h1><h2 id="什么是-mcp-客户端" tabindex="-1">什么是 MCP 客户端 <a class="header-anchor" href="#什么是-mcp-客户端" aria-label="Permalink to “什么是 MCP 客户端”">​</a></h2><p>MCP 客户端是由<strong>宿主应用程序(Host Application)</strong>实例化的协议组件,负责与 MCP 服务器建立通信连接。</p><p><strong>关键区别:</strong></p><ul><li><strong>宿主应用(Host)</strong>: 用户直接交互的应用程序(如 Claude Desktop、IDE)</li><li><strong>客户端(Client)</strong>: 协议层组件,负责与服务器的通信逻辑</li></ul><div class="warning custom-block"><p class="custom-block-title">重要</p><p>一个客户端实例只能与一个服务器建立连接。如需连接多个服务器,宿主应用需要创建多个客户端实例。</p></div><h3 id="架构图示" tabindex="-1">架构图示 <a class="header-anchor" href="#架构图示" aria-label="Permalink to “架构图示”">​</a></h3>',7)),i(l,null,{default:p(()=>[i(n,{code:"graph%20LR%0A%20%20%20%20User%5B%E7%94%A8%E6%88%B7%5D%20--%3E%20Host%5B%E5%AE%BF%E4%B8%BB%E5%BA%94%E7%94%A8%5D%0A%20%20%20%20Host%20--%3E%20Client1%5B%E5%AE%A2%E6%88%B7%E7%AB%AF%201%5D%0A%20%20%20%20Host%20--%3E%20Client2%5B%E5%AE%A2%E6%88%B7%E7%AB%AF%202%5D%0A%20%20%20%20Client1%20--%3E%20Server1%5B%E6%9C%8D%E5%8A%A1%E5%99%A8%201%5D%0A%20%20%20%20Client2%20--%3E%20Server2%5B%E6%9C%8D%E5%8A%A1%E5%99%A8%202%5D%0A",showToolbar:"1"})]),_:1}),s[1]||(s[1]=a('<h2 id="客户端核心能力" tabindex="-1">客户端核心能力 <a class="header-anchor" href="#客户端核心能力" aria-label="Permalink to “客户端核心能力”">​</a></h2><p>客户端不仅消费服务器提供的能力,还可以向服务器提供以下功能:</p><table tabindex="0"><thead><tr><th>能力</th><th>说明</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>信息征询(Elicitation)</strong></td><td>允许服务器在执行过程中向用户请求必要信息</td><td>旅行预订时询问座位偏好、酒店房型</td></tr><tr><td><strong>根目录(Roots)</strong></td><td>声明服务器可访问的文件系统范围</td><td>IDE 中限定项目目录访问范围</td></tr><tr><td><strong>采样(Sampling)</strong></td><td>允许服务器通过客户端调用 LLM</td><td>航班推荐、数据分析等需要 AI 决策的场景</td></tr></tbody></table><h2 id="能力1-信息征询-elicitation" tabindex="-1">能力1：信息征询(Elicitation) <a class="header-anchor" href="#能力1-信息征询-elicitation" aria-label="Permalink to “能力1：信息征询(Elicitation)”">​</a></h2><h3 id="工作原理" tabindex="-1">工作原理 <a class="header-anchor" href="#工作原理" aria-label="Permalink to “工作原理”">​</a></h3><p>信息征询使服务器能够在需要时动态请求用户输入,而不是一次性要求所有信息。</p><p><strong>交互流程:</strong></p>',7)),i(l,null,{default:p(()=>[i(n,{code:"sequenceDiagram%0A%20%20%20%20participant%20Server%20as%20%E6%9C%8D%E5%8A%A1%E5%99%A8%0A%20%20%20%20participant%20Client%20as%20%E5%AE%A2%E6%88%B7%E7%AB%AF%0A%20%20%20%20participant%20User%20as%20%E7%94%A8%E6%88%B7%0A%20%20%20%20%0A%20%20%20%20Server-%3E%3EClient%3A%20elicitation%2Fcreate%0A%20%20%20%20Note%20over%20Client%3A%20%E8%A7%A3%E6%9E%90%E8%AF%B7%E6%B1%82%20schema%0A%20%20%20%20Client-%3E%3EUser%3A%20%E5%B1%95%E7%A4%BA%E8%A1%A8%E5%8D%95%20UI%0A%20%20%20%20User-%3E%3EClient%3A%20%E5%A1%AB%E5%86%99%E5%B9%B6%E6%8F%90%E4%BA%A4%0A%20%20%20%20Client-%3E%3EServer%3A%20%E8%BF%94%E5%9B%9E%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%0A%20%20%20%20Note%20over%20Server%3A%20%E7%BB%A7%E7%BB%AD%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%0A",showToolbar:"1"})]),_:1}),s[2]||(s[2]=a(`<h3 id="代码示例" tabindex="-1">代码示例 <a class="header-anchor" href="#代码示例" aria-label="Permalink to “代码示例”">​</a></h3><p><strong>服务器发起信息征询:</strong></p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">{</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;method&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;elicitation/requestInput&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;params&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;message&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;请确认您的巴塞罗那假期预订&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;schema&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">      &quot;type&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;object&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">      &quot;properties&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">        &quot;confirmBooking&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">          &quot;type&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;boolean&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">          &quot;description&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;确认预订(机票+酒店=$3,000)&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">        }</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">        &quot;seatPreference&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">          &quot;type&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;string&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">          &quot;enum&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;靠窗&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;靠走廊&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;无偏好&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">]</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">        }</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">        &quot;roomType&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">          &quot;type&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;string&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">          &quot;enum&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;海景房&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;城景房&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;花园房&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">]</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">        }</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">        &quot;travelInsurance&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">          &quot;type&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;boolean&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">          &quot;default&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">          &quot;description&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;添加旅行保险($150)&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      }</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">      &quot;required&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;confirmBooking&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">]</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="最佳实践" tabindex="-1">最佳实践 <a class="header-anchor" href="#最佳实践" aria-label="Permalink to “最佳实践”">​</a></h3><p><strong>用户体验设计:</strong></p><ul><li>清晰说明请求来源(哪个服务器发起)</li><li>解释数据用途和隐私政策</li><li>提供拒绝或取消选项</li><li><strong>不要</strong>请求密码或 API 密钥</li></ul><h2 id="能力2-根目录-roots" tabindex="-1">能力2：根目录(Roots) <a class="header-anchor" href="#能力2-根目录-roots" aria-label="Permalink to “能力2：根目录(Roots)”">​</a></h2><h3 id="工作原理-1" tabindex="-1">工作原理 <a class="header-anchor" href="#工作原理-1" aria-label="Permalink to “工作原理”">​</a></h3><p>Roots 定义服务器可访问的文件系统边界,帮助服务器理解其操作范围。</p><div class="danger custom-block"><p class="custom-block-title">注意</p><p>Roots 是<strong>协调机制</strong>,不是安全边界。真正的访问控制应由操作系统权限实现。</p></div><h3 id="配置示例" tabindex="-1">配置示例 <a class="header-anchor" href="#配置示例" aria-label="Permalink to “配置示例”">​</a></h3><p><strong>旅行规划工作区配置:</strong></p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">{</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;roots&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">      &quot;uri&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;file:///Users/agent/travel-planning&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">      &quot;name&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;主工作区&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    }</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">      &quot;uri&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;file:///Users/agent/travel-templates&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">      &quot;name&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;行程模板&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    }</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">      &quot;uri&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;file:///Users/agent/client-documents&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">      &quot;name&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;客户文件&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="动态更新" tabindex="-1">动态更新 <a class="header-anchor" href="#动态更新" aria-label="Permalink to “动态更新”">​</a></h3><p>当用户切换项目时,客户端可通过 <code>roots/list_changed</code> 通知服务器:</p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">// 用户打开新文件夹</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> client</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.notify</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">({</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  method</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &#39;roots/list_changed&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="能力3-采样-sampling" tabindex="-1">能力3：采样(Sampling) <a class="header-anchor" href="#能力3-采样-sampling" aria-label="Permalink to “能力3：采样(Sampling)”">​</a></h2><h3 id="工作原理-2" tabindex="-1">工作原理 <a class="header-anchor" href="#工作原理-2" aria-label="Permalink to “工作原理”">​</a></h3><p>采样允许服务器通过客户端请求 LLM 推理,实现 Agent 化工作流,同时保持用户控制权。</p><p><strong>交互流程:</strong></p>`,20)),i(l,null,{default:p(()=>[i(n,{code:"sequenceDiagram%0A%20%20%20%20participant%20Server%20as%20%E6%9C%8D%E5%8A%A1%E5%99%A8%0A%20%20%20%20participant%20Client%20as%20%E5%AE%A2%E6%88%B7%E7%AB%AF%0A%20%20%20%20participant%20User%20as%20%E7%94%A8%E6%88%B7%0A%20%20%20%20participant%20LLM%20as%20%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%0A%20%20%20%20%0A%20%20%20%20Server-%3E%3EClient%3A%20sampling%2FcreateMessage%0A%20%20%20%20Client-%3E%3EUser%3A%20%E5%B1%95%E7%A4%BA%E8%AF%B7%E6%B1%82%2C%E8%AF%B7%E6%B1%82%E6%8E%88%E6%9D%83%0A%20%20%20%20User-%3E%3EClient%3A%20%E6%89%B9%E5%87%86%2F%E4%BF%AE%E6%94%B9%0A%20%20%20%20Client-%3E%3ELLM%3A%20%E5%8F%91%E9%80%81%20Prompt%0A%20%20%20%20LLM-%3E%3EClient%3A%20%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%0A%20%20%20%20Client-%3E%3EUser%3A%20%E5%B1%95%E7%A4%BA%E7%BB%93%E6%9E%9C%E4%BE%9B%E5%AE%A1%E6%A0%B8%0A%20%20%20%20User-%3E%3EClient%3A%20%E7%A1%AE%E8%AE%A4%2F%E4%BF%AE%E6%94%B9%0A%20%20%20%20Client-%3E%3EServer%3A%20%E8%BF%94%E5%9B%9E%E6%9C%80%E7%BB%88%E7%BB%93%E6%9E%9C%0A",showToolbar:"1"})]),_:1}),s[3]||(s[3]=a(`<h3 id="代码示例-1" tabindex="-1">代码示例 <a class="header-anchor" href="#代码示例-1" aria-label="Permalink to “代码示例”">​</a></h3><p><strong>航班推荐场景:</strong></p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">{</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;messages&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">      &quot;role&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;user&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">      &quot;content&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;分析这 47 个航班选项,推荐最符合以下偏好的航班:\\n- 早班机优先\\n- 最多 1 次中转\\n- 预算 $1000 以内&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  ]</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;modelPreferences&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;hints&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [{ </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">&quot;name&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;claude-sonnet-4-20250514&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> }]</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;intelligencePriority&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;"> 0.9</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;speedPriority&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;"> 0.2</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;systemPrompt&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;你是旅行专家,帮助用户根据偏好选择最佳航班&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;maxTokens&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;"> 1500</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="安全设计" tabindex="-1">安全设计 <a class="header-anchor" href="#安全设计" aria-label="Permalink to “安全设计”">​</a></h3><p><strong>Human-in-the-Loop 检查点:</strong></p><ol><li><strong>请求审核</strong>: 用户批准发送给 LLM 的 Prompt</li><li><strong>结果审核</strong>: 用户确认返回给服务器的数据</li><li><strong>透明性</strong>: 展示完整上下文和模型选择</li></ol><h2 id="开发-mcp-客户端实战" tabindex="-1">开发 MCP 客户端实战 <a class="header-anchor" href="#开发-mcp-客户端实战" aria-label="Permalink to “开发 MCP 客户端实战”">​</a></h2><blockquote><p>以 <code>Anthropic</code> 为例，使用 <code>Nodejs</code> + <code>TypeScript</code> 开发</p></blockquote><h3 id="前置要求" tabindex="-1">前置要求 <a class="header-anchor" href="#前置要求" aria-label="Permalink to “前置要求”">​</a></h3><ul><li><strong>运行环境</strong>: macOS / Windows / Linux</li><li><strong>Node.js</strong>: v20 或更高版本</li><li><strong>API 密钥</strong>: <a href="https://console.anthropic.com/settings/keys" target="_blank" rel="noreferrer">Anthropic API Key</a> 或者其他大模型的 API Key</li></ul><h3 id="快速开始" tabindex="-1">快速开始 <a class="header-anchor" href="#快速开始" aria-label="Permalink to “快速开始”">​</a></h3><h4 id="_1-项目初始化" tabindex="-1">1. 项目初始化 <a class="header-anchor" href="#_1-项目初始化" aria-label="Permalink to “1. 项目初始化”">​</a></h4><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;"># 创建项目</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> mcp-client-demo</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;"> &amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cd</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> mcp-client-demo</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;"># 初始化 npm</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> init</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> -y</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;"># 安装依赖</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> install</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> @anthropic-ai/sdk</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> @modelcontextprotocol/sdk</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> dotenv</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;"># 安装开发依赖</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> install</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> -D</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> @types/node</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> typescript</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;"># 创建源文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">touch</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> index.ts</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> .env</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_2-配置-typescript" tabindex="-1">2. 配置 TypeScript <a class="header-anchor" href="#_2-配置-typescript" aria-label="Permalink to “2. 配置 TypeScript”">​</a></h4><p><strong>tsconfig.json:</strong></p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">{</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;compilerOptions&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;target&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;ES2022&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;module&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;Node16&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;moduleResolution&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;Node16&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;outDir&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;./build&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;rootDir&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;./&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;strict&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;esModuleInterop&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> true</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;include&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;index.ts&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">]</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;exclude&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;node_modules&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">]</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>package.json 添加脚本:</strong></p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">{</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;type&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;module&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">  &quot;scripts&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;build&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;tsc&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F8F8F8;">    &quot;start&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;node build/index.js&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_3-配置环境变量" tabindex="-1">3. 配置环境变量 <a class="header-anchor" href="#_3-配置环境变量" aria-label="Permalink to “3. 配置环境变量”">​</a></h4><p><strong>.env 文件:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">ANTHROPIC_API_KEY</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;">your_api_key_here</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>.gitignore:</strong></p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span>node_modules/</span></span>
<span class="line"><span>build/</span></span>
<span class="line"><span>.env</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="核心代码实现" tabindex="-1">核心代码实现 <a class="header-anchor" href="#核心代码实现" aria-label="Permalink to “核心代码实现”">​</a></h3><h4 id="客户端类结构" tabindex="-1">客户端类结构 <a class="header-anchor" href="#客户端类结构" aria-label="Permalink to “客户端类结构”">​</a></h4><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> { Anthropic } </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;@anthropic-ai/sdk&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">;</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> { Client } </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;@modelcontextprotocol/sdk/client/index.js&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">;</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> { StdioClientTransport } </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;@modelcontextprotocol/sdk/client/stdio.js&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">;</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> dotenv </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;dotenv&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">dotenv</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.config</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MCPClient</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> mcpClient</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Client</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">;</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> anthropic</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Anthropic</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">;</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> transport</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StdioClientTransport</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">;</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> availableTools</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Tool</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">[] </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  constructor</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">() {</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // 初始化 Anthropic 客户端</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.anthropic </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Anthropic</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">({</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      apiKey</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> process</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">env</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">ANTHROPIC_API_KEY</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // 初始化 MCP 客户端</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.mcpClient </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Client</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">({</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      name</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;mcp-client-demo&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      version</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;1.0.0&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">  // 连接到 MCP 服务器</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> connectToServer</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(serverPath</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">)</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">&lt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // 判断服务器类型</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> isJavaScript</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> serverPath</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.endsWith</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;.js&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> isPython</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> serverPath</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.endsWith</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;.py&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> (</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">isJavaScript </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">isPython) {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">      throw</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;服务器脚本必须是 .js 或 .py 文件&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // 设置执行命令</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> command</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> isPython </span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">      ?</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> (</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">process</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.platform </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;win32&quot;</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;python&quot;</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;python3&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">      :</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> process</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.execPath;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // 创建传输层</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.transport </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StdioClientTransport</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">({</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      command</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      args</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [serverPath]</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // 建立连接</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">mcpClient</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.connect</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.transport);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // 获取可用工具列表</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> { </span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">tools</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> } </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">mcpClient</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.listTools</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">();</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.availableTools </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> tools</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.map</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(tool </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> ({</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      name</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> tool</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.name</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      description</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> tool</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.description</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      input_schema</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> tool</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.inputSchema</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    }));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    console</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.log</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;已连接到服务器&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    console</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.log</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;可用工具:&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">availableTools</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.map</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(t </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> t</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.name)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.join</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;, &quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">));</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">  // 处理用户查询</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processQuery</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(userQuery</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">)</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">&lt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> messages</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [{ role</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;user&quot;</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> content</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> userQuery }];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // 调用 Claude</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> response </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">anthropic</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">messages</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.create</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">({</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      model</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;claude-sonnet-4-20250514&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      max_tokens</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;"> 1000</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      messages</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      tools</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.availableTools</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> results</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">[] </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // 处理响应</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> (</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> content</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> of</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.content) {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> (</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">content</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.type </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;text&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">) {</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">        results</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.push</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">content</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.text);</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      } </span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">      else</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> (</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">content</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.type </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;tool_use&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">) {</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">        // 执行工具调用</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> toolResult</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">mcpClient</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.callTool</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">({</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">          name</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> content</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.name</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">          arguments</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> content</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.input</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">        });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">        results</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.push</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">\`调用工具: </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">\${</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">content</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.name</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">\`</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">        // 将工具结果返回给 Claude</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">        messages</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.push</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">          { role</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;assistant&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> content</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.content }</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">          { role</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;user&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> content</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> toolResult</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.content </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">        );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">        // 获取 Claude 的最终回复</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">        response </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">anthropic</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">messages</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.create</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">({</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">          model</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;claude-sonnet-4-20250514&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">          max_tokens</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;"> 1000</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">          messages</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">          tools</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.availableTools</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">        });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> finalText</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">content</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.find</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(c </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> c</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.type </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;text&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> (finalText </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> finalText</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.type </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;text&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">) {</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">          results</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.push</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">finalText</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.text);</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> results</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.join</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;\\n\\n&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">  // 启动交互式会话</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> startChat</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">()</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">&lt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> readline</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;readline/promises&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> rl</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> readline</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.createInterface</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">({</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      input</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> process</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.stdin</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      output</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> process</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.stdout</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    console</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.log</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;\\nMCP 客户端已启动&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    console</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.log</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;输入 &#39;quit&#39; 退出\\n&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">      while</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> (</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">) {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> query</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> rl</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.question</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;您: &quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">        </span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> (</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">query</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.toLowerCase</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">() </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;quit&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">) {</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">          console</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.log</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;再见!&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">          break</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.processQuery</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(query);</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">        console</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.log</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">\`\\nClaude: </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">\${</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">response</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">\\n\`</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    } </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">      rl</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.close</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">();</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">      await</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.cleanup</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">();</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">  // 清理资源</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cleanup</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">()</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">&lt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">mcpClient</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.close</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">();</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br></div></div><h4 id="主程序入口" tabindex="-1">主程序入口 <a class="header-anchor" href="#主程序入口" aria-label="Permalink to “主程序入口”">​</a></h4><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">() {</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">  // 检查命令行参数</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> (</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">process</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">argv</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;"> 3</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">) {</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    console</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.error</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;用法: npm start &lt;服务器脚本路径&gt;&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    console</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.error</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;示例: npm start ./server/build/index.js&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    process</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.exit</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;">1</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> serverPath</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> process</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.argv[</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;">2</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">];</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> client</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MCPClient</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  try</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> client</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.connectToServer</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(serverPath);</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> client</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.startChat</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">();</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  } </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    console</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.error</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;错误:&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> error);</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    process</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.exit</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;">1</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">main</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">();</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="运行客户端" tabindex="-1">运行客户端 <a class="header-anchor" href="#运行客户端" aria-label="Permalink to “运行客户端”">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;"># 编译 TypeScript</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> run</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> build</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;"># 启动客户端(连接到服务器)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> start</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> /path/to/server/build/index.js</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;"># 或使用相对路径</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> start</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> ../mcp-server/build/index.js</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="工作流程详解" tabindex="-1">工作流程详解 <a class="header-anchor" href="#工作流程详解" aria-label="Permalink to “工作流程详解”">​</a></h2><h3 id="完整交互流程" tabindex="-1">完整交互流程 <a class="header-anchor" href="#完整交互流程" aria-label="Permalink to “完整交互流程”">​</a></h3>`,32)),i(l,null,{default:p(()=>[i(n,{code:"sequenceDiagram%0A%20%20%20%20participant%20User%20as%20%E7%94%A8%E6%88%B7%0A%20%20%20%20participant%20Client%20as%20MCP%20%E5%AE%A2%E6%88%B7%E7%AB%AF%0A%20%20%20%20participant%20Server%20as%20MCP%20%E6%9C%8D%E5%8A%A1%E5%99%A8%0A%20%20%20%20participant%20Claude%20as%20Claude%20API%0A%20%20%20%20%0A%20%20%20%20User-%3E%3EClient%3A%20%E8%BE%93%E5%85%A5%E6%9F%A5%E8%AF%A2%0A%20%20%20%20Client-%3E%3EServer%3A%20%E8%8E%B7%E5%8F%96%E5%B7%A5%E5%85%B7%E5%88%97%E8%A1%A8%0A%20%20%20%20Server--%3E%3EClient%3A%20%E8%BF%94%E5%9B%9E%E5%8F%AF%E7%94%A8%E5%B7%A5%E5%85%B7%0A%20%20%20%20Client-%3E%3EClaude%3A%20%E5%8F%91%E9%80%81%E6%9F%A5%E8%AF%A2%2B%E5%B7%A5%E5%85%B7%E6%8F%8F%E8%BF%B0%0A%20%20%20%20Claude--%3E%3EClient%3A%20%E5%86%B3%E5%AE%9A%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7%20X%0A%20%20%20%20Client-%3E%3EServer%3A%20%E8%B0%83%E7%94%A8%E5%B7%A5%E5%85%B7%20X%0A%20%20%20%20Server--%3E%3EClient%3A%20%E8%BF%94%E5%9B%9E%E5%B7%A5%E5%85%B7%E7%BB%93%E6%9E%9C%0A%20%20%20%20Client-%3E%3EClaude%3A%20%E5%8F%91%E9%80%81%E5%B7%A5%E5%85%B7%E7%BB%93%E6%9E%9C%0A%20%20%20%20Claude--%3E%3EClient%3A%20%E7%94%9F%E6%88%90%E6%9C%80%E7%BB%88%E5%9B%9E%E5%A4%8D%0A%20%20%20%20Client-%3E%3EUser%3A%20%E5%B1%95%E7%A4%BA%E5%9B%9E%E5%A4%8D%0A",showToolbar:"1"})]),_:1}),s[4]||(s[4]=a(`<h3 id="关键步骤说明" tabindex="-1">关键步骤说明 <a class="header-anchor" href="#关键步骤说明" aria-label="Permalink to “关键步骤说明”">​</a></h3><ol><li><strong>工具发现</strong>: 客户端从服务器获取可用工具清单</li><li><strong>智能决策</strong>: Claude 分析查询,决定是否需要使用工具</li><li><strong>工具执行</strong>: 客户端通过 MCP 协议调用服务器工具</li><li><strong>结果整合</strong>: Claude 基于工具返回结果生成自然语言回复</li></ol><h2 id="最佳实践-1" tabindex="-1">最佳实践 <a class="header-anchor" href="#最佳实践-1" aria-label="Permalink to “最佳实践”">​</a></h2><h3 id="错误处理" tabindex="-1">错误处理 <a class="header-anchor" href="#错误处理" aria-label="Permalink to “错误处理”">​</a></h3><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">async </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">processQuery</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(query: string): </span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">Promise</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">string</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  try {</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // 核心逻辑</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  } catch (error) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> (error instanceof Anthropic.APIError) {</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">      console</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.error</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;Anthropic API 错误:&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> error</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.message);</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;抱歉,调用 AI 服务时出错,请稍后重试&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> (error instanceof Error &amp;&amp; error.message.includes(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;tool&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">)) {</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">      console</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.error</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;工具调用失败:&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> error</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.message);</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;工具执行失败,请检查服务器状态&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    </span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    throw error; </span><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">// 未知错误继续抛出</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="安全性检查清单" tabindex="-1">安全性检查清单 <a class="header-anchor" href="#安全性检查清单" aria-label="Permalink to “安全性检查清单”">​</a></h3><ul><li>将 API 密钥存储在 <code>.env</code> 文件中</li><li>添加 <code>.env</code> 到 <code>.gitignore</code></li><li>验证服务器返回的工具定义</li><li>为工具调用设置超时限制</li><li>记录敏感操作审计日志</li></ul><h3 id="性能优化" tabindex="-1">性能优化 <a class="header-anchor" href="#性能优化" aria-label="Permalink to “性能优化”">​</a></h3><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MCPClient</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> toolCache </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">&lt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Tool</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> connectToServer</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(serverPath</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">) {</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // ... 连接逻辑</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    </span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // 缓存工具定义,避免重复获取</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    tools</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.forEach</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(tool </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">      this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">toolCache</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.set</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">tool</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.name</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> tool);</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="故障排除" tabindex="-1">故障排除 <a class="header-anchor" href="#故障排除" aria-label="Permalink to “故障排除”">​</a></h2><h3 id="常见错误及解决方案" tabindex="-1">常见错误及解决方案 <a class="header-anchor" href="#常见错误及解决方案" aria-label="Permalink to “常见错误及解决方案”">​</a></h3><table tabindex="0"><thead><tr><th>错误信息</th><th>可能原因</th><th>解决方法</th></tr></thead><tbody><tr><td><code>Cannot find module</code></td><td>TypeScript 编译失败</td><td>运行 <code>npm run build</code> 检查编译错误</td></tr><tr><td><code>ANTHROPIC_API_KEY is not set</code></td><td>环境变量未加载</td><td>检查 <code>.env</code> 文件和 <code>dotenv.config()</code> 调用</td></tr><tr><td><code>Connection refused</code></td><td>服务器未启动或路径错误</td><td>验证服务器路径,确保服务器正在运行</td></tr><tr><td><code>Tool execution failed</code></td><td>服务器内部错误</td><td>查看服务器日志,检查工具实现</td></tr></tbody></table><h3 id="路径问题排查" tabindex="-1">路径问题排查 <a class="header-anchor" href="#路径问题排查" aria-label="Permalink to “路径问题排查”">​</a></h3><p><strong>Windows 用户注意:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;"># ✓ 正确 - 使用正斜杠</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> start</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> C:/projects/server/build/index.js</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;"># ✓ 正确 - 转义反斜杠</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> start</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> C:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">\\\\</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;">projects</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">\\\\</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;">server</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">\\\\</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;">build</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">\\\\</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;">index.js</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;"># x 错误 - 未转义的反斜杠</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> start</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;"> C:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">\\p</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;">rojects</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">\\s</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;">erver</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">\\b</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;">uild</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">\\i</span><span style="--shiki-light:#2B5581;--shiki-dark:#9DB1C5;">ndex.js</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>调试技巧:</strong></p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">// 在 connectToServer 方法开头添加</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">console</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.log</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;尝试连接服务器:&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> serverPath);</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">console</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.log</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;文件是否存在:&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;fs&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.existsSync</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(serverPath));</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="进阶扩展" tabindex="-1">进阶扩展 <a class="header-anchor" href="#进阶扩展" aria-label="Permalink to “进阶扩展”">​</a></h2><h3 id="添加自定义功能" tabindex="-1">添加自定义功能 <a class="header-anchor" href="#添加自定义功能" aria-label="Permalink to “添加自定义功能”">​</a></h3><p><strong>1. 实现会话历史:</strong></p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MCPClient</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> {</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> conversationHistory</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MessageParam</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">[] </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processQuery</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(query</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">)</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">&lt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">conversationHistory</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.push</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">({</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      role</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;user&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      content</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> query</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">anthropic</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">messages</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.create</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">({</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      model</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;claude-sonnet-4-20250514&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      max_tokens</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;"> 1000</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      messages</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.conversationHistory</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;"> // 使用完整历史</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      tools</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.availableTools</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // 保存助手回复</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">conversationHistory</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.push</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">({</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      role</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;assistant&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">      content</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> response</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.content</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">    // 限制历史长度</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> (</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">conversationHistory</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;"> 20</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">) {</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">      this</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.conversationHistory </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">conversationHistory</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.slice</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#1976D2;--shiki-dark:#F8F8F8;">20</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">);</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.formatResponse</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(response);</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><strong>2. 添加日志系统:</strong></p><div class="language-typescript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes min-light min-dark" style="--shiki-light:#24292eff;--shiki-dark:#b392f0;--shiki-light-bg:#ffffff;--shiki-dark-bg:#1f1f1f;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> winston </span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;winston&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> logger</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> winston</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.createLogger</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">({</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  level</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;info&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  format</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> winston</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">format</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.json</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">()</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  transports</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> [</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    new</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> winston</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">transports</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.File</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">({ filename</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;"> &quot;mcp-client.log&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> })</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">    new</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> winston</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">transports</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.Console</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">()</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">  ]</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#6B737C;">// 在关键位置添加日志</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">logger</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.info</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;连接到服务器&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> { serverPath });</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">logger</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.debug</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;调用工具&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> { toolName</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> arguments });</span></span>
<span class="line"><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;">logger</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.error</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#FFAB70;">&quot;处理查询失败&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#BBBBBB;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;"> { error</span><span style="--shiki-light:#D32F2F;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#79B8FF;"> error</span><span style="--shiki-light:#24292EFF;--shiki-dark:#B392F0;">.message });</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="相关资源" tabindex="-1">相关资源 <a class="header-anchor" href="#相关资源" aria-label="Permalink to “相关资源”">​</a></h2><h3 id="官方文档" tabindex="-1">官方文档 <a class="header-anchor" href="#官方文档" aria-label="Permalink to “官方文档”">​</a></h3><ul><li><a href="https://spec.modelcontextprotocol.io/" target="_blank" rel="noreferrer">MCP 协议规范</a></li><li><a href="https://github.com/modelcontextprotocol/typescript-sdk" target="_blank" rel="noreferrer">TypeScript SDK</a></li><li><a href="https://github.com/modelcontextprotocol/python-sdk" target="_blank" rel="noreferrer">Python SDK</a></li></ul><h3 id="示例项目" tabindex="-1">示例项目 <a class="header-anchor" href="#示例项目" aria-label="Permalink to “示例项目”">​</a></h3><ul><li><a href="https://github.com/modelcontextprotocol/quickstart-resources/tree/main/mcp-client-typescript" target="_blank" rel="noreferrer">完整代码仓库</a></li><li><a href="https://github.com/modelcontextprotocol/servers" target="_blank" rel="noreferrer">官方服务器示例</a></li></ul><h3 id="社区支持" tabindex="-1">社区支持 <a class="header-anchor" href="#社区支持" aria-label="Permalink to “社区支持”">​</a></h3><ul><li><a href="https://github.com/modelcontextprotocol/specification/discussions" target="_blank" rel="noreferrer">GitHub Discussions</a></li><li><a href="https://discord.gg/modelcontextprotocol" target="_blank" rel="noreferrer">Discord 社区</a></li></ul><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to “总结”">​</a></h2><p>通过本指南,你应该掌握了:</p><p><strong>✓ 概念理解</strong></p><ul><li>MCP 客户端与宿主应用的关系</li><li>三大核心能力(信息征询、根目录、采样)的应用场景</li></ul><p><strong>✓ 实战技能</strong></p><ul><li>搭建完整的 TypeScript MCP 客户端</li><li>实现与服务器的通信和工具调用</li><li>构建交互式聊天界面</li></ul><p><strong>✓ 工程实践</strong></p><ul><li>错误处理和安全防护</li><li>性能优化和故障排查</li><li>代码组织和可维护性</li></ul><p>现在你可以开始构建自己的 MCP 客户端应用了! 🚀</p>`,39))])}const u=t(r,[["render",F]]);export{b as __pageData,u as default};
